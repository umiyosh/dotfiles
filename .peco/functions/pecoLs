#!/usr/bin/env zsh
self=$0

# 概要: lsしてpecoしてアクションする
function $self::_replaceChar() {
  # adhocなやつ
  perl -pe 's{ \Domain Users}{\DomainUsers}g'
  # | tee > /tmp/debug.log
}

function $self::_interporatePath() {
  perl -e 'while(<STDIN>){
    if (not $ARGV[0] =~ /\./) {
      print "$ARGV[0]/$_";
    } else {
      print $_;
    }
  }' $1
}

searchPath=$@
if [[ -z $searchPath ]]; then
  searchPath="."
fi
if [[ $searchPath != "." && ! $searchPath  =~ "/$" ]]; then
  searchPath=$searchPath/
fi

find $searchPath -maxdepth 0 -print0 |xargs -0 ls -al | _pecoBeforeFilter | $self::_replaceChar | \
  peco --prompt "[$0]"| awk '{print $NF}' | $self::_interporatePath $searchPath | pecoAfterAction \
    "vi" \
    "cd" \
    'zip -e ./archive.$(date +%Y%m%d%H%M%S).zip' \
    'tar cvfz ./archive.$(date +%Y%m%d%H%M%S).tar.gz' \
    'vimdiff' \
    'less +F'\
    'cat'\
    'zcat'\
    'gzcat'\
    'gunzip'\
    'chmod +x'\
    'open' \
    "%%STDIN%% cat" \
    "%%STDIN%% paaSafeRm" \
    "paaInputCommandAny" \
    "%%STDIN%% paaPbCopy" \
    "%%STDIN%% paaPbCopyFilename" \
    "%%STDIN%% paaTovim" \
    "%%STDIN%% pecoPipe" \
    "%%STDIN%% paaExecuteAsCommand"
