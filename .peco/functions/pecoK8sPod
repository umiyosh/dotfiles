#!/usr/bin/env zsh
#概要： podに対してなにかする やつ

function _getIp() {
  while read node;do
    (kubectl describe node $node|egrep Addresses:|awk '{print $NF}'|awk 'BEGIN{FS=","}{print $1}'|perl -pe 's/^$//g') &
  done
  wait
}
function _convertPodToNode() {
  while read pod ;do
    (kubectl get po $pod -o wide | awk '{print $NF}' |egrep -v '^NODE$') &
  done
  wait
}
function nodeSsh() {
  _convertPodToNode | sort | uniq | _getIp | pecoAfterAction pssh
}

function _k8sSh() {
  pods=("$@")
  tcmd kubectlSh $pods
}

function k8sSh() {
  pecoAfterAction _k8sSh
}

function k8sPortForward() {
	local podName=$1
	if [[ -z $podName ]]
	then
		return 1
	fi
	local port=$(kubectl get pod --output=json $podName|gron |grep -i containerport |perl -pe 's/.+=|;//g'|perl -pe 's/ //g')
	echo kubectl port-forward $podName $port:$port
	kubectl port-forward $1 $port:$port
}

function k8sGetPodIP() {
	local podName=$1
	if [[ -z $podName ]]
	then
		return 1
	fi
  kubectl get pod --output=json $podName|gron|grep -i podip | perl -pe 's/.+=|;//g'|perl -pe 's/ //g' | perl -pe 's/"//g'
}

kubectl get po -o wide | peco --prompt "[$0]"| awk '{print $1}'|sort | uniq | \
  pecoAfterAction \
    "kubectl describe pod " \
    "kubectl logs " \
    "kubectl logs -f " \
    "kubectl get pod " \
    "kubectl get pod --output=json " \
    "kubectl get pod --output=yaml " \
    "k8sGetPodIP" \
    "k8sPortForward" \
    "%%STDIN%% k8sSh" \
    "%%STDIN%% nodeSsh" \
    "%%STDIN%% cat" \
    "%%STDIN%% paaTovim" \
    "%%STDIN%% pecoPipe" \
    "%%STDIN%% paaPbCopy"
